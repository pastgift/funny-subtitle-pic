<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
  <script src="js/vue.min.js"></script>
  <script src="js/axios.min.js"></script>
  <script src="js/html2canvas.min.js"></script>
  <script src="js/clipboard.min.js"></script>
  <title>Funny Subtitle Pic</title>
</head>

<style type="text/css">
  body {
    padding-top: 100px;
    margin     : 0;
    background : #202020;
  }
  #imageConfig {
    display   : block;
    position  : fixed;
    padding   : 10px;
    top       : 0;
    width     : 100%;
    background: whitesmoke;
    z-index   : 1;
  }
  #imageConfig > input,
  #imageConfig > select {
    font-size    : 20px;
    text-align   : center;
    border-radius: 7px;
    border       : 2px solid grey;
    padding      : 5px;
  }
  #imageConfig > strong {
    margin-left: 20px;
  }
  #imageConfig > small {
    vertical-align: bottom;
  }
  #hint {
    position: absolute;
    right: 50px;
    font-size: 30px;
  }
  #imagePreview  {
  }
  .image-card {
    display : inline-block;
    margin  : 15px;
    position: relative;
    width   : 300px;
    height  : 300px;
    cursor  : pointer;
  }
  .image-card > img {
    width : 100%;
    height: 100%;
  }
  .image-card > .image-card-subtitle {
    font-size  : 25px;
    position   : absolute;
    bottom     : 0px;
    width      : 100%;
    text-align : center;
    color      : white;
    background : black;
    margin     : 0;
    padding    : 5px 0;
    white-space: normal;
  }
  #picToCopy {
    height: 0;
    width: 0;
  }
  #successInfo {
    position: fixed;
    top: 40%;
    z-index: 2;
    background: black;
    width: 100%;
    padding: 30px 0;
    text-align: center;
    font-family: monospace;
    color: white;
    font-size: 50px;
    border-top: 3px solid white;
    border-bottom: 3px solid white;
  }
</style>

<body>
  <div id="app">
    <div id="imageConfig">
      <strong>Subtitle:</strong>
      <input v-model="subtitle" style="width: 300px;">
      <small>Use <code>\n</code> to break line</small>

      <strong>Font Size:</strong>
      <input type="number" min="10" max="50" step="1" v-model="fontSize" style="width: 60px;">

      <strong>Image Size:</strong>
      <input type="number" min="100" max="500" step="10" v-model="imageSize" style="width: 60px;">

      <strong>Topic:</strong>
      <select v-model="imageTopic" style="width: 200px;">
        <option value="">ALL</option>
        <option v-for="topic in IMAGE_TOPIC" :key="topic" :value="topic">{{ topic }}</option>
      </select>

      <strong id="hint">CLICK IMAGE TO COPY!</strong>
    </div>

    <div id="imagePreview">
      <div
        class="image-card"
        v-for="url in IMAGE_LIST"
        :style="{'width': imageSize + 'px', 'height': imageSize + 'px'}"
        :key="url"
        :id="url"
        @click.stop="getPicBase64(url)">
        <img :src="url">
        <pre
          class="image-card-subtitle"
          :style="{'font-size': imageSize * fontSize / 300 + 'px'}"
          v-html="formatedSubtitle"></pre>
      </div>
    </div>

    <img id="picToCopy">
    <div v-show="showSuccessInfo" id="successInfo">Copied to clipboard!</div>
  </div>
</body>

<script type="text/javascript">
var app = new Vue({
  el: '#app',
  data() {
    let subtitle   = localStorage.getItem('subtitle');
    let fontSize   = parseInt(localStorage.getItem('fontSize'));
    let imageSize  = parseInt(localStorage.getItem('imageSize'));
    let imageTopic = localStorage.getItem('imageTopic');

    return {
      subtitle       : subtitle   || 'SHOW ME YOUR CODE',
      fontSize       : fontSize   || '25',
      imageSize      : imageSize  || '300',
      imageTopic     : imageTopic || '',
      showSuccessInfo: false,

      imageIndex: [],
    }
  },
  watch: {
    subtitle(val) {
      localStorage.setItem('subtitle', val);
    },
    fontSize(val) {
      localStorage.setItem('fontSize', val);
    },
    imageSize(val) {
      localStorage.setItem('imageSize', val);
    },
    imageTopic(val) {
      localStorage.setItem('imageTopic', val);
    },
  },
  computed: {
    IMAGE_TOPIC() {
      let topicMap = {};
      this.imageIndex.forEach(d => {
        let [_, topic, name] = d.split('/');
        topicMap[topic] = true;
      });
      return Object.keys(topicMap);
    },
    IMAGE_LIST() {
      let imageList = [];
      this.imageIndex.forEach(d => {
        let [_, topic, name] = d.split('/');
        if (this.imageTopic && topic !== this.imageTopic) return;
        imageList.push(d);
      });
      return imageList;
    },
    formatedSubtitle() {
      return this.subtitle.replace('\\n', '<br>');
    },
  },
  methods: {
    getPicBase64(url) {
      var el = document.getElementById(url);
      let opt = {
        scale     : 1,
        logging   : false,
        useCORS   : true,
        allowTaint: true,
        width     : parseInt(this.imageSize),
        height    : parseInt(this.imageSize),
        x         : el.offsetLeft,
        y         : el.offsetTop,
        ignoreElements: el => {
          if (el.classList && el.classList.contains('image-subtitle')) {
            return true;
          }
          return false;
        },
      }
      html2canvas(document.body, opt).then(function(cavans) {
        var picToCopy = document.getElementById('picToCopy');
        picToCopy.src = cavans.toDataURL('image/png');

        var selection = window.getSelection();
        var range = document.createRange();

        range.selectNode(picToCopy);
        selection.removeAllRanges();
        selection.addRange(range);

        document.execCommand('copy');

        app.showSuccessInfo = true;
        setTimeout(function() {
          app.showSuccessInfo = false;
        }, 1500);
      });
    },
  },
  mounted() {
    axios.get('img-index.txt').then(resp => {
      this.imageIndex = resp.data.split('\n').filter(d => d).sort();
    });

    window.vm = this;
  },
});
</script>
</html>
